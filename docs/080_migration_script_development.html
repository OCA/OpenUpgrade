<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Migration script development &mdash; OpenUpgrade 16.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=42b9a8fd"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Field Fast Precomputation" href="use_cases/field_fast_precomputation.html" />
    <link rel="prev" title="Migration Files" href="070_migration_files.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            OpenUpgrade
          </a>
              <div class="version">
                16.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="010_introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="020_required_knowledge.html">Required Knowledge</a></li>
<li class="toctree-l1"><a class="reference internal" href="030_coverage_analysis.html">Coverage Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="040_run_migration.html">Running the migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="050_after_migration.html">After migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="060_odoo_migration_manager.html">The Odoo Migration Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="070_migration_files.html">Migration Files</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Migration script development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#learn-from-typical-use-cases">Learn from typical Use cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="use_cases/field_fast_precomputation.html">Field Fast Precomputation</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/field_renaming.html">Field Renaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/model_renaming.html">Model Renaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/table_renaming.html">Table Renaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/xml_id_renaming.html">XML-ID Renaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/module_renaming.html">Module Renaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/module_merging.html">Module Merging</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/noupdate_xml_entry_changed.html">Noupdate XML entry Changed</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/noupdate_xml_entry_changed.html#rationale">Rationale</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/format_value_changing.html">Format Value Changing</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/value_mapping.html">Value Mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="use_cases/sql_constraint_deleted.html">SQL Constraint Deleted</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#learn-from-existing-migration-scrips">Learn from existing migration scrips</a></li>
<li class="toctree-l2"><a class="reference internal" href="#learn-from-code-review-of-open-prs">Learn from code review of open PRs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-trial-and-error-process-for-the-development-of-your-scripts">The Trial and error process for the development of your scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#restart-the-upgrade-of-the-failed-module-instead-of-upgrading-all-systematically">Restart the upgrade of the failed module instead of upgrading all systematically</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#learning-resources">Learning resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="090_contribute.html">Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OpenUpgrade</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Migration script development</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="migration-script-development">
<h1>Migration script development<a class="headerlink" href="#migration-script-development" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>As explained with more detail in the page “Migration Manager”
(<a class="reference internal" href="060_odoo_migration_manager.html"><span class="doc">The Odoo Migration Manager</span></a>), the migration scripts
of a module are usually the combination of 3 python files (might be less if some
steps are not necessary):</p>
<ul class="simple">
<li><p>pre-migration.py</p></li>
<li><p>post-migration.py</p></li>
<li><p>end-migration.py</p></li>
</ul>
<p>Since version 14, these files can be found here:</p>
<p><code class="docutils literal notranslate"><span class="pre">openupgrade_scripts/scripts/&lt;module-name&gt;</span></code></p>
<p>Each of those files will contain a function <cite>migrate</cite> which is called by the
Migration Manager.</p>
<p>Then, the function migrate will call other functions. Each of these functions
will execute a task of the migration, these functions are the one which
needs most of the work from developers. These functions are usually declared in the
same file.</p>
<p>Luckily, many pre-existing functions already exist within <cite>openupgradelib</cite> reducing
significantly the work of development.
See <a class="reference external" href="https://oca.github.io/openupgradelib/API.html">OpenUpgrade API</a></p>
<p>For many modules, a developer will not even need to write any function, but will
“simply” need to call pre-existing functions from <cite>openupgradelib</cite> with the appropriate
arguments. The main complexities becomes to learn what are the functions available in
<cite>openupgradelib</cite> and then to select appropriatly the arguments (usually according to
the <cite>openupgrade_analysis.txt</cite>, see below).</p>
<p>For instance, the migration to version 13 of mass_mailing did not require any custom
function: <a class="reference external" href="https://github.com/OCA/OpenUpgrade/pull/2273/files">https://github.com/OCA/OpenUpgrade/pull/2273/files</a></p>
<p>After this introduction, which highlight how simple the migration scripts can be,
do not underestimate the power of OpenUpgrade.
The migration of the account module to version 13 is the kind of situation where
the full power of OpenUpgrade was unleashed to successfully overcome the
“acc-pocalypse”:
<a class="reference external" href="https://github.com/OCA/OpenUpgrade/pull/2275/files">https://github.com/OCA/OpenUpgrade/pull/2275/files</a>.</p>
</section>
<section id="learn-from-typical-use-cases">
<h2>Learn from typical Use cases<a class="headerlink" href="#learn-from-typical-use-cases" title="Link to this heading"></a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="use_cases/field_fast_precomputation.html">Field Fast Precomputation</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/field_renaming.html">Field Renaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/model_renaming.html">Model Renaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/table_renaming.html">Table Renaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/xml_id_renaming.html">XML-ID Renaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/module_renaming.html">Module Renaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/module_merging.html">Module Merging</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/noupdate_xml_entry_changed.html">Noupdate XML entry Changed</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/noupdate_xml_entry_changed.html#rationale">Rationale</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/format_value_changing.html">Format Value Changing</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/value_mapping.html">Value Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="use_cases/sql_constraint_deleted.html">SQL Constraint Deleted</a></li>
</ul>
</div>
</section>
<section id="learn-from-existing-migration-scrips">
<h2>Learn from existing migration scrips<a class="headerlink" href="#learn-from-existing-migration-scrips" title="Link to this heading"></a></h2>
<p>Since version 14, the migration scripts are located in:</p>
<p><code class="docutils literal notranslate"><span class="pre">openupgrade_scripts/scripts/&lt;module-name&gt;</span></code></p>
<p>During the review for a given module, you can follow this process:</p>
<ul class="simple">
<li><p>Review the analysis (read more in <a class="reference internal" href="070_migration_files.html"><span class="doc">Migration Files</span></a>). First the file
<cite>openupgrade_analysis.txt</cite> showing some differences between the 2 versions of
the module. Then, <cite>openupgrade_analysis_work.txt</cite> to see what the developer
planned to do.</p></li>
<li><p>Then you can check the other files to see how the plan was achieved.</p></li>
</ul>
<p>You should pick modules with which you are familiar with in both version and for which
you are aware of the changes.</p>
</section>
<section id="learn-from-code-review-of-open-prs">
<h2>Learn from code review of open PRs<a class="headerlink" href="#learn-from-code-review-of-open-prs" title="Link to this heading"></a></h2>
<p><a class="reference external" href="https://github.com/OCA/OpenUpgrade/pulls">https://github.com/OCA/OpenUpgrade/pulls</a></p>
<p>This will engage you in a discussion with other contributors and help you understand
how developers selected one way or another to implement the migration scripts.</p>
</section>
<section id="the-trial-and-error-process-for-the-development-of-your-scripts">
<h2>The Trial and error process for the development of your scripts<a class="headerlink" href="#the-trial-and-error-process-for-the-development-of-your-scripts" title="Link to this heading"></a></h2>
<p>Basically, this is the happening during the step when you try to run the upgrade
described in <a class="reference internal" href="040_run_migration.html"><span class="doc">Running the migration</span></a>:</p>
<ul class="simple">
<li><p>[A] get the copy of your database in old version as <cite>db-upgrade</cite>, it is
easy to do through the database manager of your old odoo
<cite>http://localhost:8069/web/database/manager</cite></p></li>
<li><p>[B] run <code class="docutils literal notranslate"><span class="pre">odoo</span> <span class="pre">-d</span> <span class="pre">db-upgrade</span> <span class="pre">-u</span> <span class="pre">all</span> <span class="pre">--stop-after-init</span></code></p></li>
<li><p>[C] In case of error, fix the error adding or editing migration
scripts within the module to fix, then rerun with <code class="docutils literal notranslate"><span class="pre">-u</span> <span class="pre">&lt;fixed_module&gt;</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">-u</span> <span class="pre">all</span></code>.
This way of running is only done for testing purposes and will help you
save a lot of time in the development process.
Whenever facing unexpected errors, you might want to restart from [A] as
this step will leave your database in an inconsistent state.</p></li>
<li><p>[D] After all issues are fixed go back to <code class="docutils literal notranslate"><span class="pre">--update</span> <span class="pre">all</span></code> to ensure that all
dependent modules have been upgraded.</p></li>
</ul>
<section id="restart-the-upgrade-of-the-failed-module-instead-of-upgrading-all-systematically">
<h3>Restart the upgrade of the failed module instead of upgrading all systematically<a class="headerlink" href="#restart-the-upgrade-of-the-failed-module-instead-of-upgrading-all-systematically" title="Link to this heading"></a></h3>
<p><strong>As an alternative to the step [C] mentioned above…</strong></p>
<p>In case of error, fix the error (adding or editing migration
scripts), then rerun <strong>without</strong> the <code class="docutils literal notranslate"><span class="pre">--update</span> <span class="pre">all</span></code>:
<code class="docutils literal notranslate"><span class="pre">odoo</span> <span class="pre">-d</span> <span class="pre">db-upgrade</span> <span class="pre">--stop-after-init</span></code>. This will continue the upgrade
process from where it left off, starting with the module that caused the
error. That way, the migration will not run the end-migration scripts of
the modules that were already upgraded before the error. But in case of a
live migration you always need to restore the database.</p>
<p>Note that for the time being, this is not available in all versions
(see explanations here: <a class="reference external" href="https://github.com/OCA/OpenUpgrade/pull/2499">https://github.com/OCA/OpenUpgrade/pull/2499</a>).
It is available only for 12 and 13:
<a class="reference external" href="https://github.com/OCA/OpenUpgrade/pulls?q=is%3Apr+%5BFIX%5D+reset+exception">https://github.com/OCA/OpenUpgrade/pulls?q=is%3Apr+%5BFIX%5D+reset+exception</a></p>
</section>
</section>
<section id="learning-resources">
<h2>Learning resources<a class="headerlink" href="#learning-resources" title="Link to this heading"></a></h2>
<p>You can also refer to the following:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://oca.github.io/openupgradelib/API.html">OpenUpgrade API</a></p></li>
<li><p>the code of OpenUpgrade API
<a class="reference external" href="https://github.com/OCA/openupgradelib/blob/master/openupgradelib/openupgrade.py">openupgrade.py</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="070_migration_files.html" class="btn btn-neutral float-left" title="Migration Files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="use_cases/field_fast_precomputation.html" class="btn btn-neutral float-right" title="Field Fast Precomputation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2012-2021, Odoo Community Association (OCA) / The OpenUpgrade developers.
      <span class="lastupdated">Last updated on Feb 15, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>